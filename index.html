<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NECSC Project Map and Portal</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Loading Font Awesome -->
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>

  <!-- Loading Leaflet library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
    integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>

  <!-- Loading ESRI Leaflet -->
  <script src="https://unpkg.com/esri-leaflet@2.0.8/dist/esri-leaflet.js"></script>

  <!-- Loading Mapzen geocoding plugin for search -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.9.2/leaflet-geocoder-mapzen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.9.2/leaflet-geocoder-mapzen.js"></script> -->

 <!-- Load Esri Leaflet Geocoder from CDN -->
 <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.6/dist/esri-leaflet-geocoder.css">
   <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.6"></script>

  <!-- Loading Leaflet.zoomhome (stored locally) -->
  <link rel="stylesheet" href="scripts/leaflet.zoomhome.css"/>
  <script src="scripts/leaflet.zoomhome.min.js"></script>

  <!-- Loading Leaflet-markercluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.css"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.Default.css"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.0.6/dist/leaflet.markercluster.js"></script>

  <!-- Loading Leaflet.MarkerCluster.LayerSupport -->
  <script src="https://unpkg.com/leaflet.markercluster.layersupport@1.0.5/dist/leaflet.markercluster.layersupport.js"></script>

  <!-- Linking to custom CSS for this map -->
  <link rel="stylesheet" href="NECSCmap.css">

</head>

<body>
  <!-- Creating container for the map -->
  <div id="map"></div>
  <!-- Creating the div for the query box and populating filters -->
  <div id="query" class="leaflet-bar">

  <label>
    <em>Filter by:</em></br>Science Theme
    <select id="Science_Themes">
      <!-- make sure to encase string values in single quotes for valid sql -->
      <option value='1=1'>All</option>
      <option value="Science_Themes LIKE '%Climate impacts on Atlantic and Great Lakes coastal and nearshore environments%'">Climate impacts on Atlantic and Great Lakes coastal and nearshore environments</option>
      <option value="Science_Themes LIKE '%Climate impacts on freshwater resources and ecosystems%'">Climate impacts on freshwater resources and ecosystems</option>
      <option value="Science_Themes LIKE '%Climate impacts on land-use and land-cover change%'">Climate impacts on land-use and land-cover change</option>
      <option value="Science_Themes LIKE '%Climate projections and assessments%'">Climate projections and assessments</option>
      <option value="Science_Themes LIKE '%Ecological vulnerability and species response to climate variability and change%'">Ecological vulnerability and species response to climate variability and change</option>
      <option value="Science_Themes LIKE '%Impacts of climate variability and change on cultural resources%'">Impacts of climate variability and change on cultural resources</option>
      <!-- <option value="Science_Themes='Climate projections and assessments'">West</option> -->
    </select>
  </label>
  </div>

  <!-- Creating the map object / script -->

  <script>
  // This creates the map object itself
    var map = L.map('map', {
      center: [43.726372, -79.405235],
      zoom: 5,
      zoomControl: false,
    });

    //-------------------------

    // MAP CONTROLS
    var zoomHome = L.Control.zoomHome({
      position: 'topleft',
      homeCoordinates: [42.389810, -72.524684],
      homeZoom: 5
    });
    zoomHome.addTo(map);

    //Adding MapZen search because frankly it's superior to ESRI's

    // L.control.geocoder('mapzen-Su28ep2', {
    //   position: 'topleft',
    // }).addTo(map);


    // INFORMATION CONTROL

    // control that shows Project Data on click
    // This control lifted from http://leafletjs.com/examples/choropleth/
    // Still not sure precisely how it works- have to investigate

    var info = L.control();

    info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
      this.update();
      return this._div;
    };

    // method that we will use to update the control based on feature properties passed
    info.update = function (props) {
      this._div.innerHTML = (props ?
         '<b>' + props.Title + '</b>' + '<br><br>' + props.Project_Leader + ' - Project Leader(s)<br><br><a href="https://necsc.umass.edu' + props.Path + '" target="_blank">More Information...</a><br><br><b>Science Themes:</b><br>' + props.Science_Themes
      : 'Click on a marker to see information about that project');
      };

    info.addTo(map);

    // ESRI FEATURE LAYER AND MAP SEARCH

    // Setting up the control and its options
    var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider();
    var searchControl = L.esri.Geocoding.geosearch({
      expanded: true,
      placeholder: 'Search NECSC Projects',
      zoomToResult: true,
      collapseAfterResult: true,
      allowMultipleResults: false,
      providers: [
        // arcgisOnline,
        L.esri.Geocoding.featureLayerProvider({
          url: 'https://services.arcgis.com/2gdL2gxYNFY2TOUb/arcgis/rest/services/NECSC_Test_Data/FeatureServer/1',
          searchFields: ['Title', 'Affiliations', 'Body', 'Partners', 'Project_Investigators', 'Project_Leader', 'Science_Themes', 'Project_Type'],
          label: 'NESC Projects',
          bufferRadius: 5000,
          formatSuggestion: function(feature){
            return feature.properties.Project_Leader + ' - ' + feature.properties.Title;
          }
        })
      ]
    }).addTo(map);

    // Setting up map behavior for clicking on the search control results
    var searchResultPolygons = L.layerGroup();
    searchResultPolygons.addTo(map);

    searchControl.on('results', function(data){
      var searchResultData = data.results[0].properties
      // Note to self: [0] after results is required to tell Leaflet which feature to get properties.etc...
      // from.  Else properties will be undefined.  Here you're telling it to just pull .properties.Title from
      // the first feature in the results object (an array) that is returned, designated 0.
      // Forcing UX here to only return one result, but as of yet don't think users will want More
      // than one result showing for a search - Choosing to keep things simple for now.
      if (data.results.length > 0) {
        info.update(searchResultData)
        ProjectMap.eachActiveFeature(function(layer){
          layer.setStyle({
          fillOpacity: 0,
          });
          // Note: Throughout script using this for styling ProjectMap w/ each change as opposed to
          // ProjectMap.setStyle, as it seems to over-ride any other setStyle functions in the entire
          // script and basically brakes changes in styling invoked anywhere else in script.
        });
        searchResultPolygons.clearLayers();
        searchResultPolygons.addLayer(L.geoJSON(data.results[0].geojson, {
          weight: 0,
          fillOpacity: 0.5,
        }));
      };
    });

    // Do not need to add listener here (I think), or L.control, to clear search results, as clicking
    // on centerpoint of any other feature or changing filters clears them.



    //-------------------------

  //MAP LAYERS

    // BASEMAP
    // Loading ESRI topo basemap from ArcOnline as baselayer
    var esriTopo = L.esri.basemapLayer('Topographic').addTo(map);

    // DATA
    // Load the project layer as object with all of the projects but do not display it on the map
    var ProjectMap = L.esri.featureLayer ({
      url: 'https://services.arcgis.com/2gdL2gxYNFY2TOUb/arcgis/rest/services/NECSC_Test_Data/FeatureServer/1',
      //making the polygons invisible
      stroke: false,
      weight: 0,
      fillOpacity: 0,
      fillColor: null,
    }).addTo(map);

  // ENABLING THE MAP FILTER

    // Retrieves the selected filter from the query control above and creates JS object from it.
    var sciencetheme = document.getElementById('Science_Themes');
    // Creates a listener for when content of variable 'sciencetheme'changes
    // and runs callback function to set the 'where' query for the esri.featureLayer to the
    // contents of the sciencetheme variable.
    sciencetheme.addEventListener('change', function(){
      ProjectMap.setWhere(sciencetheme.value, function(){
      });
      // for some reason ProjectMap.refresh() is necessary in order to get the centerpoints for the
      // currently displayed layer to load properly. This creates a huge lag in the centerpoints loading.
      // Otherwise centerpoints (see below) from previous setWhere
      // are displayed. This is likely because ProjectMap.refresh() is what triggers the ProjectMap.on('load'
      // event to fire below. Unless I'm missing something obvious, Unfortunately there's no straightforward
      // "change in where" event in Leaflet / ESRI-Leaflet that I can set up a listener for.
      ProjectMap.refresh();
      ProjectMap.eachActiveFeature(function(layer){
        layer.setStyle({
          fillOpacity: 0,
        });
      });
      searchResultPolygons.clearLayers();
    });

    // Populates the map with centerpoints for filtered features (and all features) above.
    ProjectMap.on('load', function(){
      centerpointlayer.clearLayers();
      ProjectMap.eachActiveFeature(function(layer){
        // console.log(layer.feature.properties.Science_Themes);
        var bounds = layer.getBounds();
        var center = bounds.getCenter();
        var centerpoints = L.circleMarker(center, {
          radius: 10,
          fillOpacity: 0.75,
          fillColor: '#76db58',
          color: '#76db58',
          opacity: 0.5,
        });

        centerpointlayer.addLayer(centerpoints);
        map.addLayer(centerpointlayer);

        centerpoints.on('click', function(e) {
          info.update(layer.feature.properties);
          map.fitBounds(bounds);
          searchResultPolygons.clearLayers();
          ProjectMap.eachActiveFeature(function(layer){
            layer.setStyle({
              fillOpacity: 0,
            })
          });
          layer.setStyle({
            fillOpacity: 0.5,
          });
        });
      });
    });

  // CENTERPOINT LAYER

    var centerpointlayer = L.layerGroup();

    // Clustering of the centerpoints
    var clusters = L.markerClusterGroup.layerSupport({
      showCoverageOnHover: false,
      disableClusteringAtZoom: 13,
      spiderfyDistanceMultiplier: 2,
      // zoomToBoundsOnClick: false,
    });
    clusters.addLayer(centerpointlayer);
    map.addLayer(clusters);

  </script>

</body>
</html>

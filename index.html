<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NECSC Project Map and Portal</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Loading Font Awesome -->
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>

  <!-- Loading Leaflet library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
    integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>

  <!-- Loading ESRI Leaflet -->
  <script src="https://unpkg.com/esri-leaflet@2.0.8/dist/esri-leaflet.js"></script>

  <!-- Loading Mapzen geocoding plugin for search -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.9.2/leaflet-geocoder-mapzen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.9.2/leaflet-geocoder-mapzen.js"></script>

  <!-- Loading Leaflet.zoomhome (stored locally) -->
  <link rel="stylesheet" href="scripts/leaflet.zoomhome.css"/>
  <script src="scripts/leaflet.zoomhome.min.js"></script>

  <!-- Loading Leaflet-markercluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.css"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.Default.css"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.0.6/dist/leaflet.markercluster.js"></script>

  <!-- Loading Leaflet.MarkerCluster.LayerSupport -->
  <script src="https://unpkg.com/leaflet.markercluster.layersupport@1.0.5/dist/leaflet.markercluster.layersupport.js"></script>

  <!-- Linking to custom CSS for this map -->
  <link rel="stylesheet" href="NECSCmap.css">

</head>

<body>
  <!-- Creating container for the map -->
  <div id="map"></div>
  <!-- Creating the div for the query box and populating filters -->
  <div id="query" class="leaflet-bar">

  <label>
    <em>Filter by:</em></br>Science Theme
    <select id="Science_Themes">
      <!-- make sure to encase string values in single quotes for valid sql -->
      <option value='1=1'>All</option>
      <option value="Science_Themes LIKE '%Climate impacts on Atlantic and Great Lakes coastal and nearshore environments%'">Climate impacts on Atlantic and Great Lakes coastal and nearshore environments</option>
      <option value="Science_Themes LIKE '%Climate impacts on freshwater resources and ecosystems%'">Climate impacts on freshwater resources and ecosystems</option>
      <option value="Science_Themes LIKE '%Climate impacts on land-use and land-cover change%'">Climate impacts on land-use and land-cover change</option>
      <option value="Science_Themes LIKE '%Climate projections and assessments%'">Climate projections and assessments</option>
      <option value="Science_Themes LIKE '%Ecological vulnerability and species response to climate variability and change%'">Ecological vulnerability and species response to climate variability and change</option>
      <option value="Science_Themes LIKE '%Impacts of climate variability and change on cultural resources%'">Impacts of climate variability and change on cultural resources</option>
      <!-- <option value="Science_Themes='Climate projections and assessments'">West</option> -->
    </select>
  </label>
  </div>

  <!-- Creating the map object / script -->

  <script>
  // This creates the map object itself
    var map = L.map('map', {
      center: [43.726372, -79.405235],
      zoom: 5,
      zoomControl: false,

    });
    // Loading ESRI topo basemap from ArcOnline as baselayer
    var esriTopo = L.esri.basemapLayer('Topographic').addTo(map);

    // Loading controls
    var zoomHome = L.Control.zoomHome({
      position: 'topleft',
      homeCoordinates: [42.389810, -72.524684],
      homeZoom: 5
    });
    zoomHome.addTo(map);

    //Adding MapZen search because frankly it's superior to ESRI's

    L.control.geocoder('mapzen-Su28ep2', {
      position: 'topleft',
    }).addTo(map);

    // control that shows Project Data on click
    // This control lifted from http://leafletjs.com/examples/choropleth/
    // Still not sure precisely how it works- have to investigate

    var info = L.control();

    info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
      this.update();
      return this._div;
    };

    // method that we will use to update the control based on feature properties passed
    info.update = function (props) {
      this._div.innerHTML = (props ?
         '<b>' + props.Title + '</b>' + '<br><br>' + props.Project_Leader + ' - Project Leader(s)<br><br><a href="https://necsc.umass.edu' + props.Path + '" target="_blank">More Information...</a><br><br><b>Science Themes:</b><br>' + props.Science_Themes
      : 'Click on a marker to see information about that project');
      };

    info.addTo(map);

    // Load the project layer as object with all of the projects but do not display it on the map
    var ProjectMap = L.esri.featureLayer ({
      url: 'https://services.arcgis.com/2gdL2gxYNFY2TOUb/arcgis/rest/services/NECSC_Test_Data/FeatureServer/1',
      //making the polygons invisible
      stroke: false,
      weight: 0,
      fillOpacity: 0,
    }).addTo(map);

    // Retrieves the selected filter from the query control above and creates JS object from it.
    var sciencetheme = document.getElementById('Science_Themes');
    // Creates a listener for when content of variable 'sciencetheme'changes
    // and runs callback function to set the 'where' query for the esri.featureLayer to the
    // contents of the sciencetheme variable.
    sciencetheme.addEventListener('change', function(){
      ProjectMap.setWhere(sciencetheme.value, function(){
        // console.clear();
        // console.log(sciencetheme.value);
      });
      // for some reason ProjectMap.refresh() is necessary in order to get the centerpoints for the
      // currently displayed layer to load properly. Otherwise centerpoints (see below) from previous setWhere
      // are displayed. This could be because ProjectMap.refresh() is what triggers the ProjectMap.on('load'
      // event to fire below. Unfortunately there's no "change in where" event that I can set up a listener
      // for and I don't feel like extending methods right now.
      ProjectMap.refresh();
      ProjectMap.eachActiveFeature(function(layer){
        layer.setStyle({
          fillOpacity: 0,
        })
      });
    });

    // Populates the map with centerpoints for filtered features (and all features) above.
    ProjectMap.on('load', function(){
      centerpointlayer.clearLayers();
      ProjectMap.eachActiveFeature(function(layer){
        // console.log(layer.feature.properties.Science_Themes);
        var bounds = layer.getBounds();
        var center = bounds.getCenter();
        var centerpoints = L.marker(center);

        centerpointlayer.addLayer(centerpoints);
        map.addLayer(centerpointlayer);

        centerpoints.on('click', function(e) {
          info.update(layer.feature.properties);
          map.fitBounds(bounds);
          ProjectMap.eachActiveFeature(function(layer){
            layer.setStyle({
              fillOpacity: 0,
            })
          });
          layer.setStyle({
            fillOpacity: 0.5,
          });
        });
      });
    });

    var centerpointlayer = L.layerGroup();

    // Clustering of the centerpoints
    var clusters = L.markerClusterGroup.layerSupport({
      showCoverageOnHover: false,
      // disableClusteringAtZoom: 6
      // zoomToBoundsOnClick: false,
    });
    clusters.addLayer(centerpointlayer);
    map.addLayer(clusters);

  </script>

</body>
</html>

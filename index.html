<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NECSC Project Map and Portal</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Loading Font Awesome -->
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>

  <!-- Loading Leaflet library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
    integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>

  <!-- Loading ESRI Leaflet -->
  <script src="https://unpkg.com/esri-leaflet@2.0.4/dist/esri-leaflet.js"></script>
  <!-- <script src="https://unpkg.com/@turf/turf@3.5.2/turf.min.js"></script> -->

  <!-- Loading ESRI geocoder to use for searching NECSC Database-->
  <!-- <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.6/dist/esri-leaflet-geocoder.css">
  <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.6"></script> -->

  <!-- Loading Mapzen geocoding plugin for search -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.9.2/leaflet-geocoder-mapzen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.9.2/leaflet-geocoder-mapzen.js"></script>

  <!-- Loading Leaflet.zoomhome (stored locally) -->
  <link rel="stylesheet" href="scripts/leaflet.zoomhome.css"/>
  <script src="scripts/leaflet.zoomhome.min.js"></script>


  <!-- Loading Leaflet-markercluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.css"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.Default.css"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.0.6/dist/leaflet.markercluster.js"></script>

  <!-- Loading Leaflet.MarkerCluster.LayerSupport -->
  <script src="https://unpkg.com/leaflet.markercluster.layersupport@1.0.5/dist/leaflet.markercluster.layersupport.js"></script>


<!-- css styling the map div used below -->

<style>
  html,
  body,
  #map {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
  }
</style>

<!-- css styling of the information div used below -->
<style>
.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,1);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
    width: 300px;
}
.info h4 {
    margin: 0 0 5px;
    color: #777;
}
</style>

</head>

<body>
  <!-- Creating container for the map -->
  <div id="map"></div>

  <!-- Creating the map object / script -->

  <script>
  // This creates the map object itself
    var map = L.map('map', {
      center: [42.389810, -72.524684],
      zoom: 5,
      zoomControl: false,

    });
    // Loading ESRI topo basemap from ArcOnline as baselayer
    var esriTopo = L.esri.basemapLayer('Topographic').addTo(map);

    // Loading controls
    var zoomHome = L.Control.zoomHome({
      position: 'topleft',
      homeCoordinates: [42.389810, -72.524684],
      homeZoom: 5
    });
    zoomHome.addTo(map);

    // Adding search bar that also searches NECSC data
    // var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider();
    // var NESCdata = L.esri.Geocoding.featureLayerProvider({
    //   url: 'https://services.arcgis.com/2gdL2gxYNFY2TOUb/arcgis/rest/services/NECSC_Test_Data/FeatureServer/1',
    //   searchFields: ['Title', 'Affiliations', 'Body', 'Partners', 'Project_Fiscal_Year', 'Project_Investigators', 'ProjectLeader','Project_Other','Project_Type','Science_Themes'],
    //   label: 'Search NESC Projects',
    //   formatSuggestion: function(feature){
    //     return feature.properties.Project_Leader + ' - ' + feature.properties.Title;
    //   }
    // });
    //
    // L.esri.Geocoding.geosearch({
    //   position: 'topleft',
    //   providers: [arcgisOnline, NESCdata]
    // }).addTo(map);

    //Adding MapZen search because frankly it's superior

    L.control.geocoder('mapzen-Su28ep2', {
      position: 'topleft',
    }).addTo(map);

    // control that shows Project Data on click
    // This control lifted from http://leafletjs.com/examples/choropleth/
    // Still not sure precisely how it works- have to investigate

    var info = L.control();

    info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
      this.update();
      return this._div;
    };

    // method that we will use to update the control based on feature properties passed
    info.update = function (props) {
      this._div.innerHTML = (props ?
         '<b>' + props.Title + '</b>' + '<br><br>' + props.Project_Leader + ' - Project Leader(s)<br><br><a href="https://necsc.umass.edu' + props.Path + '" target="_blank">More Information...</a><br><br><b>Science Themes:</b><br>' + props.Science_Themes
      : 'Click on a marker to see information about that project');
      };

    info.addTo(map);

    // Load the project layer as object with all of the projects but do not display it on the map
    var ProjectMap = L.esri.featureLayer ({
      url: 'https://services.arcgis.com/2gdL2gxYNFY2TOUb/arcgis/rest/services/NECSC_Test_Data/FeatureServer/1',
      //making the polygons invisible
      weight: 0,
      fillOpacity: 0,
      // this snippet creates LatLng object 'center'.  apparently can't do this with layer.getBounds().getCenter(); I don't know why.

      onEachFeature: function(feature,layer){
        if (feature.geometry.type = 'Polygon') {
          // console.log(feature.geometry.type);
          var bounds = layer.getBounds();
          var center = bounds.getCenter();

          // console.log(center);
          // gives LatLng object coordinates just to make sure it's working

          var centerpoints = L.marker(center);
          centerpointlayer.addLayer(centerpoints);
          // The above creates a single marker for each polygon feature (in Leaflet, called a Layer) and then adds that layer to the featureGroup centerpoint layer, defined below

          // When clicking on centerpoint, zooms to bounds of polygon above, defined by variable 'bounds'
          // Need to add "back" or "zoom to full map" button.
          // Also need to make centerpoint "disappear" with styling when zoomed in. should be easy.

          centerpoints.on("click", function (event){
            map.fitBounds(bounds);
            layer.setStyle({
              fillOpacity: 0.5,
            });
            info.update(layer.feature.properties);

            // layer.bindPopup(function (layer) {
            //   return L.Util.template ('{Title}', layer.feature.properties);
            // }).openPopup();
          // centerpoints.setStyle({
          //   opacity: 0,
          // });
          });
        };
      }

    }).addTo(map);

    //Creating the markerClusters
    var centerpointlayer = L.layerGroup();
    map.addLayer(centerpointlayer);
    var clusters = L.markerClusterGroup.layerSupport({
      showCoverageOnHover: false,
      // disableClusteringAtZoom: 6
      // zoomToBoundsOnClick: false,
    });
    clusters.addLayer(centerpointlayer);
    map.addLayer(clusters);

  </script>

</body>
</html>
